(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{205:function(e,t,s){e.exports=s.p+"assets/img/cluster-health.b50d2961.png"},220:function(e,t,s){"use strict";s.r(t);var a=s(0),r=Object(a.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"recovering-from-lost-master-hosts"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#recovering-from-lost-master-hosts","aria-hidden":"true"}},[e._v("#")]),e._v(" Recovering from lost master hosts")]),e._v(" "),a("p",[e._v("It is possible to use the etcd backup to recover from the scenario where one or more master nodes have been lost. This includes situations where a majority of master hosts have been lost, leading to etcd quorum loss and the cluster going offline. The following procedure assumes that you have at least one healthy master host.")]),e._v(" "),a("div",{staticClass:"warning custom-block"},[a("p",[e._v("This procedure can be used to validate that your etcd backup has succeeded, but it is highly invasive in that it\nrequires you to destroy master nodes and would render your cluster unusable for the duration of the procedure.")])]),e._v(" "),a("p",[e._v("The information in this section is taken from "),a("a",{attrs:{href:"https://docs.openshift.com/container-platform/4.2/backup_and_restore/disaster_recovery/scenario-1-infra-recovery.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://docs.openshift.com/container-platform/4.2/backup_and_restore/disaster_recovery/scenario-1-infra-recovery.html"),a("OutboundLink")],1),e._v(". Please check the latest version of the OpenShift documentation for any updates to this procedure.")]),e._v(" "),a("h2",{attrs:{id:"prerequisites"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#prerequisites","aria-hidden":"true"}},[e._v("#")]),e._v(" Prerequisites")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("Ensure  that you can access the first master node "),a("code",[e._v("ocp-master0")]),e._v(" using "),a("code",[e._v("ssh")])])]),e._v(" "),a("li",[a("p",[e._v("Ensure that you have taken a backup, as outlined in the preceding section")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("ls")]),e._v(" -al  ~/backups/\n\n-rw-rw-r--.  "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v(" core core   "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("625040")]),e._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("22")]),e._v(" 09:18 backup_2019_09_22_131749.misc.tgz\n-rw-rw-r--.  "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v(" core core "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("21732338")]),e._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("22")]),e._v(" 09:18 backup_2019_09_22_131749.snapshots.tgz\n")])])])])]),e._v(" "),a("p",[e._v("Unpack the snapshots:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" ~/backups\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("tar")]),e._v(" -xvf backup_2019_09_22_131749.snapshots.tgz\n\nocp-master1/\nocp-master0/\nocp-master2/\nocp-master1/assets/\nocp-master1/assets/backup/\nocp-master1/assets/backup/snapshot.db\nocp-master1/assets/backup/etcd-member.yaml\nocp-master1/assets/backup/etcd-client.key\nocp-master1/assets/backup/etcd-client.crt\nocp-master1/assets/backup/etcd-ca-bundle.crt\nocp-master0/assets/\nocp-master0/assets/backup/\nocp-master0/assets/backup/snapshot.db\nocp-master0/assets/backup/etcd-member.yaml\nocp-master0/assets/backup/etcd-client.key\nocp-master0/assets/backup/etcd-client.crt\nocp-master0/assets/backup/etcd-ca-bundle.crt\nocp-master2/assets/\nocp-master2/assets/backup/\nocp-master2/assets/backup/snapshot.db\nocp-master2/assets/backup/etcd-member.yaml\nocp-master2/assets/backup/etcd-client.key\nocp-master2/assets/backup/etcd-client.crt\nocp-master2/assets/backup/etcd-ca-bundle.crt\n")])])]),a("h2",{attrs:{id:"loss-of-two-master-nodes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#loss-of-two-master-nodes","aria-hidden":"true"}},[e._v("#")]),e._v(" Loss of two master nodes")]),e._v(" "),a("p",[e._v("If you lose (or purposely delete) two master nodes, etcd quorum will be lost and this will lead to the cluster going offline. If you the try to run "),a("code",[e._v("oc")]),e._v(" commands, they will not respond:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("$ oc get nodes\n")])])]),a("p",[e._v("If you view the cluster health in the web console, you will see that the control plane status is unknown.")]),e._v(" "),a("p",[a("img",{attrs:{src:s(205),alt:'"Cluster health"',title:"Figure. Cluster health"}})]),e._v(" "),a("p",[a("strong",[e._v("Figure. Cluster health")])]),e._v(" "),a("h2",{attrs:{id:"restore-etcd-quorum-on-the-remaining-master"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#restore-etcd-quorum-on-the-remaining-master","aria-hidden":"true"}},[e._v("#")]),e._v(" Restore etcd quorum on the remaining master")]),e._v(" "),a("p",[e._v("Copy a snapshot from the backup to the remaining master:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("scp")]),e._v(" ~/backups/ocp-master0/assets/backup/snapshot.db core@ocp-master0:~/\n")])])]),a("p",[e._v("Connect to the remaining master "),a("code",[e._v("ocp-master0")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("ssh")]),e._v("  ocp-master0\n\nWarning: Permanently added "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'ocp-master0,10.15.155.210'")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("ECDSA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" to the list of known hosts.\nRed Hat Enterprise Linux CoreOS "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("410.8")]),e._v(".20190830.0\nWARNING: Direct SSH access to machines is not recommended.\n\n---\nLast login: Sun Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("22")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("13")]),e._v(":18:33 "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2019")]),e._v(" from "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10.15")]),e._v(".155.7\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("core@ocp-master0 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("$\n\n")])])]),a("p",[e._v("Set the "),a("code",[e._v("INITIAL_CLUSTER")]),e._v(" variable to the single remaining member, in the format of "),a("code",[e._v("<name>=<url>")]),e._v(". First,\nyou need to determine the "),a("code",[e._v("name")]),e._v(" and "),a("code",[e._v("url")]),e._v(" to use:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ETCDCTL")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/var/home/core/assets/bin/etcdctl\n$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ASSET_DIR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/home/core/assets/\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ETCDCTL_API")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("${ETCDCTL}")]),e._v(" --cert "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$ASSET_DIR")]),e._v("/backup/etcd-client.crt --key "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$ASSET_DIR")]),e._v("/backup/etcd-client.key --cacert "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$ASSET_DIR")]),e._v("/backup/etcd-ca-bundle.crt member list\n\n1daf5dbed09ea2d3, started, etcd-member-ocp-master2, https://etcd-2.ocp.hpecloud.org:2380, https://10.15.155.212:2379\n333583b05ff2cf8a, started, etcd-member-ocp-master0, https://etcd-0.ocp.hpecloud.org:2380, https://10.15.155.210:2379\n4be0034d015274a2, started, etcd-member-ocp-master1, https://etcd-1.ocp.hpecloud.org:2380, https://10.15.155.211:2379\n")])])]),a("p",[e._v("Now, set the "),a("code",[e._v("INITIAL_CLUSTER")]),e._v(" environment variable using the information gathered for "),a("code",[e._v("ocp-master0")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("INITIAL_CLUSTER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"etcd-member-ocp-master0.ocp.hpecloud.org=https://etcd-0.ocp.hpecloud.org:2380"')]),e._v("\n")])])]),a("p",[e._v("Run the "),a("code",[e._v("etcd-snapshot-restore.sh")]),e._v(" script, using the copied snapshot and the member list, in this case, just the "),a("code",[e._v("ocp-master0")]),e._v(" member:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" /usr/local/bin/etcd-snapshot-restore.sh /home/core/snapshot.db "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$INITIAL_CLUSTER")]),e._v("\n\n\nDownloading etcdctl binary"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\netcdctl version: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3.3")]),e._v(".10\nAPI version: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3.3")]),e._v("\netcd-member.yaml found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("in")]),e._v(" ./assets/backup/\nStopping all static pods"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("stopping etcd-member.yaml\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("stopping kube-scheduler-pod.yaml\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("stopping kube-controller-manager-pod.yaml\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("stopping kube-apiserver-pod.yaml\nStopping etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" etcd-member to stop\nStopping kubelet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nStopping all containers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\n019708c6aff244dbc47f90cec65c4823a93b8e3fe731f3a5e8f3cdedb0dc37ed\n81eed61df3ee87bd960602f23e598ab48b43a6cb5610f4ecfed709f1e1b67119\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v(".\nBacking up etcd data-dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nRemoving etcd data-dir /var/lib/etcd\nRestoring etcd member etcd-member-ocp-master0.ocp.hpecloud.org from snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2019")]),e._v("-09-22 "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("14")]),e._v(":18:21.903011 I "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" pkg/netutil: resolving etcd-0.ocp.hpecloud.org:2380 to "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10.15")]),e._v(".155.210:2380\n"),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2019")]),e._v("-09-22 "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("14")]),e._v(":18:22.154363 I "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" mvcc: restore compact to "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("713621")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2019")]),e._v("-09-22 "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("14")]),e._v(":18:22.207764 I "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" etcdserver/membership: added member 1c5a549c9f4e67b5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("https://etcd-0.ocp.hpecloud.org:2380"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(" to cluster 11eeb64feb9a2071\nStarting static pods"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("starting etcd-member.yaml\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("starting kube-scheduler-pod.yaml\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("starting kube-controller-manager-pod.yaml\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("starting kube-apiserver-pod.yaml\nStarting kubelet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\n")])])]),a("p",[e._v("On your Ansible controller node, check the nodes in your cluster:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ oc get nodes\n\nNAME          STATUS     ROLES    AGE   VERSION\nocp-master0   Ready      master   45h   v1.14.6+31a56cf75\nocp-master1   NotReady   master   45h   v1.14.6+31a56cf75\nocp-master2   NotReady   master   45h   v1.14.6+31a56cf75\nocp-worker0   Ready      worker   45h   v1.14.6+31a56cf75\nocp-worker1   Ready      worker   45h   v1.14.6+31a56cf75\n")])])]),a("p",[e._v("You need to explicitly delete the "),a("code",[e._v("NotReady")]),e._v(" nodes "),a("code",[e._v("ocp-master1")]),e._v(" and "),a("code",[e._v("ocp-master2")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ oc delete node ocp-master1\n$ oc delete node ocp-master2\n\n$ oc get nodes\n\nNAME          STATUS   ROLES    AGE   VERSION\nocp-master0   Ready    master   45h   v1.14.6+31a56cf75\nocp-worker0   Ready    worker   45h   v1.14.6+31a56cf75\nocp-worker1   Ready    worker   45h   v1.14.6+31a56cf75\n")])])]),a("h2",{attrs:{id:"redeploy-the-two-master-nodes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redeploy-the-two-master-nodes","aria-hidden":"true"}},[e._v("#")]),e._v(" Redeploy the two master nodes")]),e._v(" "),a("p",[e._v("You need to re-build the nodes for "),a("code",[e._v("ocp-master1")]),e._v(" and "),a("code",[e._v("ocp-master2")]),e._v(". You must ensure that your "),a("code",[e._v("/etc/hosts")]),e._v(", DNS, and load balancers are modified appropriately.")]),e._v(" "),a("h2",{attrs:{id:"grow-etcd-to-full-membership"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#grow-etcd-to-full-membership","aria-hidden":"true"}},[e._v("#")]),e._v(" Grow etcd to full membership.")]),e._v(" "),a("p",[e._v("Set up a temporary etcd certificate signer service on your master node that is an etcd member, in this case, "),a("code",[e._v("ocp-master0")]),e._v(". Connect to the master node and then log in to your cluster as a "),a("code",[e._v("cluster-admin")]),e._v(" user using the following command:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ oc login https://localhost:6443\n\nThe server uses a certificate signed by an unknown authority.\nYou can bypass the certificate check, but any data you send to the server could be intercepted by others.\nUse insecure connections? "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("y/n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(": y\n\nAuthentication required "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" https://localhost:6443 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("openshift"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\nUsername: kubeadmin\nPassword:  LX65K-DXmpC-P4Hpo-W35au\nLogin successful.\n")])])]),a("p",[e._v("Obtain the pull specification for the "),a("code",[e._v("kube-etcd-signer-server")]),e._v(" image:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KUBE_ETCD_SIGNER_SERVER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" oc adm release info --image-for kube-etcd-signer-server --registry-config"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/var/lib/kubelet/config.json --config"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/home/core/.kube/config"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("\n")])])]),a("p",[e._v("Run the "),a("code",[e._v("tokenize-signer.sh")]),e._v(" script to generate the required files:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" -E /usr/local/bin/tokenize-signer.sh ocp-master0\n\nPopulating template /usr/local/share/openshift-recovery/template/kube-etcd-cert-signer.yaml.template\nPopulating template ./assets/tmp/kube-etcd-cert-signer.yaml.stage1\nTokenized template now ready: ./assets/manifests/kube-etcd-cert-signer.yaml\n")])])]),a("p",[e._v("Use the generated "),a("code",[e._v("kube-etcd-cert-signer.yaml")]),e._v(" file to deploy the signer pod:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ oc create -f assets/manifests/kube-etcd-cert-signer.yaml\n\npod/etcd-signer created\n")])])]),a("p",[e._v("Verify that the signer is listening on this master node - it may take a minute or two to start.")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ ss -ltn "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("grep")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("9943")]),e._v("\n$ ss -ltn "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("grep")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("9943")]),e._v("\n\nLISTEN   "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("128")]),e._v("                       *:9943                   *:*\n")])])]),a("h2",{attrs:{id:"add-the-restored-master-hosts-to-the-etcd-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#add-the-restored-master-hosts-to-the-etcd-cluster","aria-hidden":"true"}},[e._v("#")]),e._v(" Add the restored master hosts to the etcd cluster")]),e._v(" "),a("p",[e._v("Connect to one of the restored master nodes, in this case, "),a("code",[e._v("ocp-master1")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("ssh")]),e._v(" ocp-master1\n")])])]),a("p",[e._v("Log in to your cluster as a cluster-admin user using the following command:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ oc login https://localhost:6443\n\nThe server uses a certificate signed by an unknown authority.\nYou can bypass the certificate check, but any data you send to the server could be intercepted by others.\nUse insecure connections? "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("y/n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(": y\n\nAuthentication required "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" https://localhost:6443 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("openshift"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\nUsername: kubeadmin\nPassword:  LX65K-DXmpC-P4Hpo-W35au\nLogin successful.\n\n")])])]),a("p",[e._v("Export two environment variables that are required by the etcd-member-recover.sh script:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("SETUP_ETCD_ENVIRONMENT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" oc adm release info --image-for setup-etcd-environment --registry-config"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/var/lib/kubelet/config.json  --config"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/home/core/.kube/config"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("\n\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KUBE_CLIENT_AGENT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" oc adm release info --image-for kube-client-agent --registry-config"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/var/lib/kubelet/config.json --config"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/home/core/.kube/config"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("\n")])])]),a("p",[e._v("Run the "),a("code",[e._v("etcd-member-recover.sh")]),e._v(" script, passing in that IP address of "),a("code",[e._v("ocp-master0")]),e._v(" and the name of the new etcd member:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" -E /usr/local/bin/etcd-member-recover.sh "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("10.15")]),e._v(".155.210 etcd-member-ocp-master1.ocp.hpecloud.org\n\nCreating asset directory ./assets\nDownloading etcdctl binary"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\netcdctl version: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3.3")]),e._v(".10\nAPI version: "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3.3")]),e._v("\nBacking up /etc/kubernetes/manifests/etcd-member.yaml to ./assets/backup/\nBacking up /etc/etcd/etcd.conf to ./assets/backup/\nTrying to backup etcd client certs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\netcd client certs found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("in")]),e._v(" /etc/kubernetes/static-pod-resources/kube-apiserver-pod-8 backing up to ./assets/backup/\nStopping etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" etcd-member to stop\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" etcd-member to stop\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" etcd-member to stop\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" etcd-member to stop\nLocal etcd snapshot "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("file")]),e._v(" not found, backup skipped"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nBacking up etcd certificates"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nPopulating template /usr/local/share/openshift-recovery/template/etcd-generate-certs.yaml.template\nPopulating template ./assets/tmp/etcd-generate-certs.stage1\nPopulating template ./assets/tmp/etcd-generate-certs.stage2\nStarting etcd client cert recovery agent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" certs to generate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" certs to generate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" certs to generate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" certs to generate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nStopping cert recover"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" generate-certs to stop\nPatching etcd-member manifest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nUpdating etcd membership"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\nMember 81d77724154f987e added to cluster 11eeb64feb9a2071\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ETCD_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"etcd-member-ocp-master1.ocp.hpecloud.org"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ETCD_INITIAL_CLUSTER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"etcd-member-ocp-master0=https://etcd-0.ocp.hpecloud.org:2380,etcd-member-ocp-master1.ocp.hpecloud.org=https://etcd-1.ocp.hpecloud.org:2380"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ETCD_INITIAL_ADVERTISE_PEER_URLS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"https://etcd-1.ocp.hpecloud.org:2380"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ETCD_INITIAL_CLUSTER_STATE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"existing"')]),e._v("\nStarting etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\n")])])]),a("h2",{attrs:{id:"verify-master-host-has-been-added-to-the-etcd-member-list"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#verify-master-host-has-been-added-to-the-etcd-member-list","aria-hidden":"true"}},[e._v("#")]),e._v(" Verify master host has been added to the etcd member list")]),e._v(" "),a("p",[e._v("From your Ansible controller node, connect to the first master "),a("code",[e._v("ocp-master1")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# ssh ocp-master0")]),e._v("\n")])])]),a("p",[e._v("Connect to the running etcd container:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("$ id=$(sudo crictl ps --name etcd-member | awk 'FNR==2{ print $1}')\n$ sudo crictl exec -it $id /bin/sh\n\nsh-4.2#\n")])])]),a("p",[e._v("In the etcd container, export variables needed for connecting to etcd:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("sh-4.2# export ETCDCTL_API=3 \nsh-4.2# export ETCDCTL_CACERT=/etc/ssl/etcd/ca.crt \nsh-4.2# export ETCDCTL_CERT=$(find /etc/ssl/ -name *peer*crt)                   \nsh-4.2# export ETCDCTL_KEY=$(find /etc/ssl/ -name *peer*key)\n")])])]),a("p",[e._v("In the etcd container, execute "),a("code",[e._v("etcdctl member list")]),e._v(" and verify that the new member is listed:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("sh-4.2# etcdctl member list -w table\n+------------------+---------+------------------------------------------+--------------------------------------+                               ----------------------------+\n|        ID        | STATUS  |                   NAME                   |              PEER ADDRS              |                                       CLIENT ADDRS        |\n+------------------+---------+------------------------------------------+--------------------------------------+                               ----------------------------+\n| 1c5a549c9f4e67b5 | started |                  etcd-member-ocp-master0 | https://etcd-0.ocp.hpecloud.org:2380 |                                https://10.15.155.210:2379 |\n| 81d77724154f987e | started | etcd-member-ocp-master1.ocp.hpecloud.org | https://etcd-1.ocp.hpecloud.org:2380 |                                https://10.15.155.211:2379 |\n+------------------+---------+------------------------------------------+--------------------------------------+                               ----------------------------+\nsh-4.2#\n")])])]),a("p",[e._v("Note that it may take up to 10 minutes for the new member to start. Repeat these steps for "),a("code",[e._v("ocp-master2")]),e._v(" until\nyou have achieved full etcd membership.")]),e._v(" "),a("p",[e._v("When you are finished restoring the etcd cluster, delete the signer pod from the OpenShift cluster:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ oc delete pod -n openshift-config etcd-signer\n")])])])])}),[],!1,null,null,null);t.default=r.exports}}]);