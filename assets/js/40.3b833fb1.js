(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{223:function(e,t,n){"use strict";n.r(t);var s=n(0),o=Object(s.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"exposing-the-image-registry"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#exposing-the-image-registry","aria-hidden":"true"}},[e._v("#")]),e._v(" Exposing the image registry")]),e._v(" "),n("p",[e._v("To allow access to the image registry from outside the cluster, you need to set up a route.")]),e._v(" "),n("h2",{attrs:{id:"check-the-registry-deployment"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#check-the-registry-deployment","aria-hidden":"true"}},[e._v("#")]),e._v(" Check the registry deployment")]),e._v(" "),n("p",[e._v("Ensure that the image registry has been deployed successfully - "),n("code",[e._v("AVAILABLE")]),e._v(" should be "),n("code",[e._v("True")]),e._v(" for "),n("code",[e._v("image-registry")]),e._v(":")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("$ oc get clusteroperators\n\nNAME                                 VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE\nauthentication                       4.2.9    True        False         False      110m\ncloud-credential                     4.2.9    True        False         False      126m\ncluster-autoscaler                   4.2.9    True        False         False      126m\nconsole                              4.2.9    True        False         False      117m\ndns                                  4.2.9    True        False         False      126m\nimage-registry                       4.2.9    True        False         False      119m\ningress                              4.2.9    True        False         False      120m\n...\n")])])]),n("h2",{attrs:{id:"add-a-route-for-the-image-registry"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#add-a-route-for-the-image-registry","aria-hidden":"true"}},[e._v("#")]),e._v(" Add a route for the image registry")]),e._v(" "),n("p",[e._v("There is no default route exposed to the image registry. To check all existing routes:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("$ oc get routes --all-namespaces\n\nNAMESPACE                  NAME                HOST/PORT                                                      PATH   SERVICES            PORT    TERMINATION            WILDCARD\nopenshift-authentication   oauth-openshift     oauth-openshift.apps.ocp.hpecloud.org                                 oauth-openshift     6443    passthrough/Redirect   None\nopenshift-console          console             console-openshift-console.apps.ocp.hpecloud.org                       console             https   reencrypt/Redirect     None\nopenshift-console          downloads           downloads-openshift-console.apps.ocp.hpecloud.org                     downloads           http    edge                   None\nopenshift-monitoring       alertmanager-main   alertmanager-main-openshift-monitoring.apps.ocp.hpecloud.org          alertmanager-main   web     reencrypt/Redirect     None\nopenshift-monitoring       grafana             grafana-openshift-monitoring.apps.ocp.hpecloud.org                    grafana             https   reencrypt/Redirect     None\nopenshift-monitoring       prometheus-k8s      prometheus-k8s-openshift-monitoring.apps.ocp.hpecloud.org             prometheus-k8s      web     reencrypt/Redirect     None\n")])])]),n("p",[e._v("There are two ways to add a default route. The first method involves editing the appropriate OCP configuration resource:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("$ oc edit configs.imageregistry.operator.openshift.io/cluster\n")])])]),n("p",[e._v('In the "spec" section, you will see '),n("code",[e._v("defaultRoute: false")]),e._v(". Edit the"),n("code",[e._v("defaultRoute")]),e._v(" value and\nset it to "),n("code",[e._v("true")]),e._v(" and then save the change.")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('apiVersion: imageregistry.operator.openshift.io/v1\nkind: Config\nmetadata:\n  creationTimestamp: "2019-09-26T11:26:36Z"\n  finalizers:\n  - imageregistry.operator.openshift.io/finalizer\n  generation: 2\n  name: cluster\n  resourceVersion: "12677"\n  selfLink: /apis/imageregistry.operator.openshift.io/v1/configs/cluster\n  uid: 80012535-e050-11e9-9ede-005056815623\nspec:\n  defaultRoute: true\n...   \n')])])]),n("p",[e._v("Alternatively, use the "),n("code",[e._v("oc patch")]),e._v(" command instead of editing the resource directly:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('$ oc patch configs.imageregistry.operator.openshift.io/cluster --type merge -p \'{"spec":{"defaultRoute":true}}\'\n\nconfig.imageregistry.operator.openshift.io/cluster patched\n')])])]),n("p",[e._v("After setting the "),n("code",[e._v("defaultRoute")]),e._v(" to "),n("code",[e._v("true")]),e._v(", re-run the "),n("code",[e._v("oc get routes")]),e._v(" command:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("$ oc get routes --all-namespaces\n\nNAMESPACE                  NAME                HOST/PORT                                                      PATH   SERVICES            PORT    TERMINATION            WILDCARD\n...\nopenshift-image-registry   default-route       default-route-openshift-image-registry.apps.ocp.hpecloud.org          image-registry      <all>   reencrypt              None\n...\n")])])]),n("p",[e._v("You should now be able to access the registry from outside the cluster at "),n("code",[e._v("default-route-openshift-image-registry.apps.ocp.hpecloud.org")])]),e._v(" "),n("p",[e._v("To test access to the image registry, start by getting your token using "),n("code",[e._v("oc whoami -t")]),e._v(":")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("$ oc whoami -t\n\n_UgOx6ujcndWWb8WXQM7sTEk7IwNSb8lpDPdWX-lRQI\n")])])]),n("p",[e._v("Now use the token in the following "),n("code",[e._v("curl")]),e._v(" command, substituting your own cluster name and domain in the URL:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('$ curl -v -tlsv1.2 --insecure -H "Authorization: Bearer _UgOx6ujcndWWb8WXQM7sTEk7IwNSb8lpDPdWX-lRQI" "https://default-route-openshift-image-registry.apps.ocp.hpecloud.org/healthz"\n\n*   Trying 10.15.156.42...\n* TCP_NODELAY set\n* Connected to default-route-openshift-image-registry.apps.ocp.hpecloud.org (10.15.156.42) port 443 (#0)\n* ALPN, offering h2\n* ALPN, offering http/1.1\n* successfully set certificate verify locations:\n*   CAfile: /etc/pki/tls/certs/ca-bundle.crt\n  CApath: none\n* TLSv1.3 (OUT), TLS handshake, Client hello (1):\n* TLSv1.3 (IN), TLS handshake, Server hello (2):\n* TLSv1.2 (IN), TLS handshake, Certificate (11):\n* TLSv1.2 (IN), TLS handshake, Server key exchange (12):\n* TLSv1.2 (IN), TLS handshake, Server finished (14):\n* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):\n* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):\n* TLSv1.2 (OUT), TLS handshake, Finished (20):\n* TLSv1.2 (IN), TLS handshake, Finished (20):\n* SSL connection using TLSv1.2 / ECDHE-RSA-AES128-GCM-SHA256\n* ALPN, server did not agree to a protocol\n* Server certificate:\n*  subject: CN=*.apps.ocp.hpecloud.org\n*  start date: Sep 26 11:26:43 2019 GMT\n*  expire date: Sep 25 11:26:44 2021 GMT\n*  issuer: CN=ingress-operator@1569497203\n*  SSL certificate verify result: self signed certificate in certificate chain (19), continuing anyway.\n> GET /healthz HTTP/1.1\n> Host: default-route-openshift-image-registry.apps.ocp.hpecloud.org\n> User-Agent: curl/7.61.1\n> Accept: */*\n> Authorization: Bearer _UgOx6ujcndWWb8WXQM7sTEk7IwNSb8lpDPdWX-lRQI\n>\n< HTTP/1.1 200 OK\n< Cache-Control: no-cache\n< Date: Thu, 26 Sep 2019 13:51:26 GMT\n< Content-Length: 0\n< Set-Cookie: 34727b82525eb26a530629c5bf0ec2f2=a086c79adfabfb34ab28ba82bf3646eb; path=/; HttpOnly; Secure\n<\n* Connection #0 to host default-route-openshift-image-registry.apps.ocp.hpecloud.org left intact\n')])])]),n("p",[e._v("From inside the OCP cluster, the registry is available at: "),n("code",[e._v("image-registry.openshift-image-registry.svc:5000")])]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("$ oc get svc  -n openshift-image-registry\n\nNAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nimage-registry   ClusterIP   172.30.146.74   <none>        5000/TCP   174m\n\n\n$  oc get pods  -n openshift-image-registry\n\nNAME                                               READY   STATUS    RESTARTS   AGE\ncluster-image-registry-operator-68586f74b7-fphjz   1/1     Running   0          175m\nimage-registry-5cfcbdfccc-nlch7                    1/1     Running   0          175m\nnode-ca-7qsx8                                      1/1     Running   0          175m\nnode-ca-dxhnh                                      1/1     Running   0          175m\nnode-ca-g48nv                                      1/1     Running   0          175m\nnode-ca-t7j5r                                      1/1     Running   0          175m\nnode-ca-v8grr                                      1/1     Running   0          175m\n")])])]),n("p",[e._v("To access the image registry logs, use the "),n("code",[e._v("oc logs")]),e._v(" command:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('$ oc logs deployments/image-registry -n openshift-image-registry\n\ntime="2019-09-26T11:28:11.62042027Z" level=info msg="start registry" distribution_version=v2.6.0+unknown go.version=go1.10.8 openshift_version=v4.2.9-201908291507+c92e458-dirty\ntime="2019-09-26T11:28:11.620887953Z" level=info msg="caching project quota objects with TTL 1m0s" go.version=go1.10.8\ntime="2019-09-26T11:28:11.621889213Z" level=info msg="redis not configured" go.version=go1.10.8\ntime="2019-09-26T11:28:11.621950581Z" level=info msg="Starting upload purge in 20m0s" go.version=go1.10.8\ntime="2019-09-26T11:28:11.636185987Z" level=info msg="using openshift blob descriptor cache" go.version=go1.10.8\ntime="2019-09-26T11:28:11.636230049Z" level=warning msg="Registry does not implement RempositoryRemover. Will not be able to delete repos and tags" go.version=go1.10.8\ntime="2019-09-26T11:28:11.637175407Z" level=info msg="Using \\"image-registry.openshift-image-registry.svc:5000\\" as Docker Registry URL" go.version=go1.10.8\ntime="2019-09-26T11:28:11.637199471Z" level=info msg="listening on :5000, tls" go.version=go1.10.8\ntime="2019-09-26T11:28:12.099368596Z" level=info msg=response go.version=go1.10.8 http.request.host="10.128.2.8:5000" http.request.id=b8a426d7-12eb-4471-b52c-00149c670af8 http.request.method=GET http.request.remoteaddr="10.128.2.1:47634" http.request.uri=/healthz http.request.useragent=kube-probe/1.13+ http.response.duration="58.451Âµs" http.response.status=200 http.response.written=0\n...\n')])])])])}),[],!1,null,null,null);t.default=o.exports}}]);